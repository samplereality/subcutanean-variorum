<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subcutanean Variorum - Compare Textual Variations</title>
    <meta name="description" content="Compare textual variations across unique editions of Aaron Reed's novel Subcutanean. Features four view modes, word differential analysis, and support for custom uploads.">
    <link rel="canonical" href="https://subcutanean.fugitivetexts.net/">

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://subcutanean.fugitivetexts.net/">
    <meta property="og:title" content="Subcutanean Variorum">
    <meta property="og:description" content="Compare textual variations across unique editions of Aaron Reed's novel Subcutanean.">
    <meta property="og:image" content="https://subcutanean.fugitivetexts.net/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Subcutanean Variorum - Compare textual variations across unique editions">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Subcutanean Variorum">
    <meta name="twitter:description" content="Compare textual variations across unique editions of Aaron Reed's novel Subcutanean.">
    <meta name="twitter:image" content="https://subcutanean.fugitivetexts.net/og-image.jpg">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="compare.css">
</head>
<body>
    <!-- Main Navigation Bar -->
    <nav class="main-nav" id="main-nav">
        <div class="nav-brand">
            <span class="nav-logo">SV</span>
            <span class="nav-title">Subcutanean Variorum</span>
        </div>

        <div class="nav-links" id="nav-links">
            <button class="nav-item" id="nav-about" title="About this project">
                <span class="nav-icon">?</span>
                <span class="nav-label">About</span>
            </button>
            <button class="nav-item" id="nav-bookmarks" title="Saved views">
                <span class="nav-icon">&#128278;</span>
                <span class="nav-label">Bookmarks</span>
            </button>
            <button class="nav-item" id="nav-files" title="Upload files">
                <span class="nav-icon">&#128194;</span>
                <span class="nav-label">Files</span>
            </button>
            <button class="nav-item" id="nav-source" title="Quant source">
                <span class="nav-icon">&lt;&gt;</span>
                <span class="nav-label">Source</span>
            </button>
            <button class="nav-item" id="nav-generate" title="Generate your own copy">
                <span class="nav-icon">&#128214;</span>
                <span class="nav-label">Generate</span>
            </button>
        </div>

        <button class="nav-mobile-toggle" id="nav-mobile-toggle" aria-label="Menu">
            <span class="nav-toggle-line"></span>
            <span class="nav-toggle-line"></span>
            <span class="nav-toggle-line"></span>
        </button>
    </nav>

    <!-- Navigation Dropdown Panels -->
    <div class="nav-dropdown" id="bookmarks-dropdown">
        <div class="dropdown-header">
            <span>Bookmarks</span>
        </div>
        <div class="dropdown-body">
            <button id="save-bookmark-btn" class="tool-btn full-width" title="Save the current versions, chapter, and view">Save Current View</button>
            <label class="bookmark-label" for="bookmark-select">Saved views:</label>
            <select id="bookmark-select" class="bookmark-select" title="Saved comparisons"></select>
            <div class="bookmark-actions">
                <button id="load-bookmark-btn" class="tool-btn" title="Load selected bookmark">Load</button>
                <button id="delete-bookmark-btn" class="tool-btn" title="Delete selected bookmark">Delete</button>
            </div>
            <div id="bookmark-empty" class="bookmark-empty hidden">No bookmarks yet.</div>
        </div>
    </div>

    <div class="nav-dropdown" id="files-dropdown">
        <div class="dropdown-header">
            <span>Files</span>
        </div>
        <div class="dropdown-body">
            <label id="files-upload-btn" for="epub-upload" class="upload-btn tool-btn full-width" title="Upload your own copy of Subcutanean">
                <span id="upload-text">Upload EPUB/TXT</span>
                <input type="file" id="epub-upload" accept=".epub,.txt" style="display: none;">
            </label>
            <button id="manage-uploads-btn" class="tool-btn full-width" title="Manage uploaded versions">Manage Uploads</button>
            <span id="upload-status" class="upload-status"></span>
        </div>
    </div>

    <div class="nav-dropdown" id="source-dropdown">
        <div class="dropdown-header">
            <span id="source-panel-title">Quant Source</span>
        </div>
        <div class="dropdown-body source-dropdown-body">
            <pre id="source-content" class="source-content"></pre>
        </div>
    </div>

    <header>
        <h1>Subcutanean Variorum</h1>
        <p class="subtitle">Compare multiple versions of Aaron Reed‚Äôs variable novel, <em>Subcutanean</em> (2020)</p>

        <div class="comparison-controls">
            <div class="version-selectors">
                <div class="selector-group">
                    <label for="version-a-select">Compare</label>
                    <select id="version-a-select" class="version-select">
                        <!-- Options populated by JavaScript -->
                    </select>
                </div>

                <div class="selector-group">
                    <label for="version-b-select">With</label>
                    <select id="version-b-select" class="version-select">
                        <!-- Options populated by JavaScript -->
                    </select>
                </div>
            </div>

            <div class="view-mode-selector">
                <label>View mode:</label>
                <div class="button-group">
                    <button id="mode-unified" class="mode-btn" title="Read a single version without comparison" data-short="Unified">Unified</button>
                    <button id="mode-sidebyside" class="mode-btn active" title="View two versions in parallel columns" data-short="Side/Side">Side-by-side</button>
                    <button id="mode-diff" class="mode-btn" title="Highlight additions and deletions between versions" data-short="Diff">Track Changes</button>
                    <button id="mode-comparison" class="mode-btn" title="Compare variations across multiple witnesses" data-short="Collation">Collation</button>
                    <button id="macro-inspector-btn" class="mode-btn hidden" title="Inspect Quant macros and variables" data-short="Macros">Macro Inspector</button>
                    <button id="syntax-toggle-btn" class="mode-btn hidden" title="Toggle Quant syntax highlighting" data-short="Syntax">Enable Syntax Highlighting</button>
                </div>
            </div>

            <div class="tools-row">
                <div class="search-box">
                    <input type="text" id="search-input" placeholder="Search text..." />
                    <button id="search-btn" class="tool-btn" title="Search across all chapters">Find</button>
                    <div class="search-navigation hidden" id="search-navigation">
                        <button id="search-prev-btn" class="search-nav-btn" title="Previous occurrence">‚Üê</button>
                        <div class="search-info">
                            <span id="search-results-count" class="search-count">0 of 0</span>
                            <span id="search-chapter-label" class="search-chapter"></span>
                        </div>
                        <button id="search-next-btn" class="search-nav-btn" title="Next occurrence">‚Üí</button>
                    </div>
                    <button id="clear-search-btn" class="tool-btn" title="Clear search results">Clear</button>
                </div>
                <button id="word-diff-btn" class="tool-btn" title="Compare unique vocabulary between two versions">Word Differential</button>
                <button id="levenshtein-btn" class="tool-btn" title="Analyze vocabulary similarity using Jaccard distance">Jaccard Distance</button>
            </div>

        </div>

        <nav id="chapter-nav" class="chapter-nav">
            <!-- Chapter buttons will be populated by JavaScript -->
        </nav>
    </header>

    <main>
        <div id="comparison-display">
            <!-- Comparison will be rendered here -->
        </div>
    </main>

    <footer>
        <p>
            <em><a href="https://subcutanean.textories.com/">Subcutanean</em></a> by Aaron Reed |
            <a href="https://github.com/samplereality/subcutanean-variorum" target="_blank">Subcutanean Variorum</a> by Mark Sample
        </p>
    </footer>

    <!-- Word Differential Modal -->
    <div id="word-diff-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Word Differential Analysis</h2>
                <p id="word-diff-description" class="modal-description"></p>
                <button id="close-modal-btn" class="close-btn">&times;</button>
            </div>
            <div class="modal-controls">
                <label>Sort by:</label>
                <div class="sort-buttons">
                    <button id="sort-alpha-btn" class="sort-btn active" title="Sort words alphabetically">Alphabetical</button>
                    <button id="sort-freq-btn" class="sort-btn" title="Sort words by frequency (most common first)">Frequency</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="diff-results">
                    <div class="unique-words-panel">
                        <h3>Unique to Seed <span id="seed-a-label"></span></h3>
                        <p class="word-count">(<span id="unique-a-count"></span> unique words)</p>
                        <div id="unique-words-a" class="word-list"></div>
                    </div>
                    <div class="unique-words-panel">
                        <h3>Unique to Seed <span id="seed-b-label"></span></h3>
                        <p class="word-count">(<span id="unique-b-count"></span> unique words)</p>
                        <div id="unique-words-b" class="word-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Word Chapter Popup -->
    <div id="word-popup" class="word-popup">
        <button id="word-popup-close" class="word-popup-close">&times;</button>
        <div class="word-popup-header">
            Chapters containing "<span id="popup-word"></span>":
        </div>
        <ul id="word-popup-chapters" class="word-popup-chapters">
            <!-- Chapters will be populated by JavaScript -->
        </ul>
    </div>

    <!-- Floating Search Navigation -->
    <div id="floating-search-nav" class="floating-search-nav hidden">
        <button id="floating-prev-btn" class="floating-nav-btn" title="Previous (Shift+F3)">‚Üë</button>
        <div class="floating-info">
            <span id="floating-count" class="floating-count">0/0</span>
            <span id="floating-chapter-label" class="floating-chapter"></span>
        </div>
        <button id="floating-next-btn" class="floating-nav-btn" title="Next (F3)">‚Üì</button>
    </div>

    <!-- Manage Uploads Modal -->
    <div id="manage-uploads-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Uploaded Versions</h2>
                <button id="close-manage-modal-btn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div id="uploads-list" class="uploads-list">
                    <!-- Upload items will be populated by JavaScript -->
                </div>
                <div id="no-uploads-message" class="no-uploads-message hidden">
                    No custom versions uploaded yet.
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy Notice Modal -->
    <div id="privacy-notice-modal" class="modal hidden">
        <div class="modal-content privacy-notice-content">
            <div class="modal-header">
                <h2>üìÅ About File Uploads</h2>
                <button id="close-privacy-modal-btn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>Your files stay on your device.</strong></p>
                <p>When you upload a file, it's stored only in your browser's local storage‚Äînot on any server. This means:</p>
                <ul>
                    <li>‚úì Your files are completely private</li>
                    <li>‚úì No data is transmitted over the internet</li>
                    <li>‚úì Only you have access to your uploaded versions</li>
                    <li>‚úì Files persist across browser sessions on this device</li>
                </ul>
                <p class="privacy-note">You can delete uploaded versions anytime using the "Manage Uploads" button.</p>
                <button id="privacy-understand-btn" class="tool-btn">Got it, proceed with upload</button>
            </div>
        </div>
    </div>

    <!-- Manage Uploads Info Modal -->
    <div id="manage-info-modal" class="modal hidden">
        <div class="modal-content privacy-notice-content">
            <div class="modal-header">
                <h2>üìÇ About Your Uploads</h2>
                <button id="close-manage-info-modal-btn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p><strong>Your uploaded files are stored locally.</strong></p>
                <p>All versions you've uploaded are stored in your browser's local storage, not on any server:</p>
                <ul>
                    <li>‚úì Files remain private to this device and browser</li>
                    <li>‚úì No data is transmitted over the internet</li>
                    <li>‚úì You can delete any version at any time</li>
                    <li>‚úì Storage is limited by your browser (typically 5-10 MB)</li>
                </ul>
                <p class="privacy-note">Use this manager to view and delete uploaded versions from your browser's storage.</p>
                <button id="manage-info-understand-btn" class="tool-btn">Got it, show my uploads</button>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="modal hidden">
        <div class="modal-content about-modal-content">
            <div class="modal-header">
                <h2>Subcutanean Variorum</h2>
                <button id="close-about-modal-btn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body about-modal-body">
                <h3>Overview</h3>
                <p>Aaron Reed‚Äôs <em>Subcutanean</em> (2020) is a novel where every copy is different. Using a combinatorial narrative system, Reed generated thousands of unique versions by varying word choices, sentence structures, and entire passages throughout the text. In 2025 Reed released the source text and code of <em>Subcutanean</em> under a CC-BY 4.0 license, meaning anyone can copy, share, modify, or remix the novel as long as credit for the original is given to Reed.</p> 
                    
                <p>This variorum allows readers to compare any two editions side-by-side to discover how the story shifts between versions.</p>

                <h4>Features</h4>
                <ul>
                    <li>25 pre-loaded unique versions (seeds 45443-45467)</li> 
                    <li>Upload additional versions (EPUB or TXT files)</li>
                    <li>Convert TXT versions of <em>Subcutanean</em> into EPUB</li>
                    <li>Four view modes: Unified, Side-by-side, Track Changes, and Collation</li>
                    <li>Cross-chapter search with keyboard shortcuts (F3, Shift+F3)</li>
                    <li>Word differential analysis showing unique vocabulary between versions</li>
                    <li>Jaccard Distance shows which variants are most similar and dissimilar to each other</li>
                </ul>

                <h4>How to Use</h4>
                <ol>
                    <li>Select two versions using the dropdown menus</li>
                    <li>Choose a view mode (Unified, Side-by-side, Track Changes, or Collation)</li>
                    <li>Navigate chapters using the chapter menu</li>
                    <li>Search for text or analyze word differences</li>
                    <li>Upload additional EPUB or TXT copies of <em>Subcutanean</em> to compare; Aaron Reed has made <a href="https://subcutanean.textories.com/seeds/" target="_blank">10,000 variants readily available</a> for download.</li>
                    <li>Under Manage Uploads, convert text files to EPUB format for use in e-readers and book apps</li>
                </ol>

                <h4>Credits</h4>
                <p><em>Subcutanean:</em> <a href="https://aaronareed.net/subcutanean/" target="_blank">Aaron Reed</a><br>
                Variorum: <a href="https:wwww.samplereality.com" target="_blank"> Mark Sample</a><br>
                Project Code: <a href="https://github.com/samplereality/subcutanean-variorum" target="_blank">GitHub Repository</a></p>

                <p class="about-note">This tool is provided by Mark Sample for scholarly and educational purposes. The text of <em>Subcutanean</em> (every single version) is by Aaron Reed.</p>
            </div>
        </div>
    </div>

    <!-- Generate Copy Modal -->
    <div id="generate-modal" class="modal hidden">
        <div class="modal-content generate-modal-content">
            <div class="modal-header">
                <h2>Generate Your Own <em>Subcutanean</em></h2>
                <button id="close-generate-modal-btn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body generate-modal-body">
                <p>In 2025, Aaron Reed released the source text and code of <em>Subcutanean</em> under a CC-BY 4.0 license. This Creative Commons license means anyone can copy, share, modify, or remix the novel as long as credit is given to Reed.</p>

                <p>Submit this form to request a freshly generated copy of <em>Subcutanean</em>. Each copy will have a unique seed number that determines its specific textual variations.</p>

                <form id="subcutanean-form">
                    <label for="generate-email">Email Address:</label>
                    <input type="email" name="email" id="generate-email" required placeholder="you@example.com">

                    <p class="format-note">By default you will receive your unique variant in both PDF and EPUB (for e-readers) formats. Would you also like a plain text version and/or HTML version?</p>

                    <div class="checkbox-group">
                        <label><input type="checkbox" name="format_choice" value="plain text"> Plain Text</label>
                        <label><input type="checkbox" name="format_choice" value="HTML (web)"> HTML (Web)</label>
                    </div>

                    <hr>

                    <label class="license-check">
                        <input type="checkbox" id="license-check" required>
                        I agree to the CC-BY 4.0 license for these unique files.
                    </label>

                    <div style="display:none;">
                        <label>Leave this field blank</label>
                        <input type="text" name="honeypot" id="generate-honeypot" tabindex="-1" autocomplete="off">
                    </div>

                    <button type="submit" id="generate-submit-btn" class="tool-btn">Generate My Variant</button>
                </form>

                <div id="generate-response-msg" class="response-msg hidden">
                    <strong>Success!</strong> Your request has been logged.
                    Your unique variant of <em>Subcutanean</em> should arrive in your inbox in 5-10 minutes. Look for an email from samplereality@gmail.com.
                </div>

                <h4>Using Your Copy with the Variorum</h4>
                <p>Once you have a copy of <em>Subcutanean</em>, you can upload it to the variorum browser to compare it with other versions using the <strong>Files</strong> button in the navigation bar.</p>

                <h4>Buy a Paperback or Download Existing Variants</h4>
                <p>You can always <a href="https://aaronareed.net/subcutanean/" target="_blank">purchase a bound paperback copy</a> of <em>Subcutanean</em> directly from its author, Aaron Reed. Reed has also made <a href="https://subcutanean.textories.com/seeds/" target="_blank">10,000 unique variants readily available</a> as text files for download from the Textories archive.</p>
            </div>
        </div>
    </div>

    <!-- Jaccard Distance Modal -->
    <div id="levenshtein-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Jaccard Distance Analysis</h2>
                <p class="modal-description" style="padding-right: 40px;">Jaccard distance measures vocabulary similarity between texts by comparing their unique word sets. Higher percentages indicate more similar vocabulary.</p>
                <button id="close-levenshtein-modal-btn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="levenshtein-summary">
                    <div class="distance-card">
                        <h3>Currently Selected Versions</h3>
                        <p class="distance-pair">
                            <strong>Seeds <span id="most-similar-seeds"></span></strong>
                        </p>
                        <p class="distance-value"><span id="most-similar-distance"></span></p>
                        <button id="load-most-similar-btn" class="tool-btn">Load These Versions</button>
                    </div>
                    <div class="distance-card">
                        <h3>Most Recently Uploaded File</h3>
                        <p class="distance-pair">
                            <strong><span id="most-different-seeds"></span></strong>
                        </p>
                        <p class="distance-value"><span id="most-different-distance"></span></p>
                        <div style="display: flex; gap: 10px; justify-content: center;">
                            <button id="load-closest-btn" class="tool-btn">Load Closest Match</button>
                            <button id="load-farthest-btn" class="tool-btn">Load Farthest Match</button>
                        </div>
                    </div>
                </div>
                <div class="matrix-section">
                    <button id="show-matrix-btn" class="tool-btn">Show All Uploaded Files</button>
                    <div id="distance-matrix" class="distance-matrix hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="macro-inspector-modal" class="modal hidden">
        <div class="modal-content macro-inspector-content">
            <div class="modal-header">
                <h2>Quant Macro Inspector</h2>
                <p id="macro-inspector-context" class="modal-description"></p>
                <button id="macro-inspector-close-btn" class="close-btn">&times;</button>
            </div>
            <div class="modal-body macro-inspector-body" id="macro-inspector-body"></div>
            <div id="macro-empty-state" class="macro-empty-state hidden">
                Load a seed alongside the Quant Source to inspect global macros.
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // Optimized Levenshtein distance implementation
        function levenshtein(a, b) {
            if (a === b) return 0;
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;

            // Swap to save memory O(min(a,b)) instead of O(a)
            if (a.length > b.length) {
                const tmp = a;
                a = b;
                b = tmp;
            }

            const row = new Array(a.length + 1);

            // Initialize first row
            for (let i = 0; i <= a.length; i++) {
                row[i] = i;
            }

            // Fill in the rest
            for (let i = 1; i <= b.length; i++) {
                let prev = i;
                for (let j = 1; j <= a.length; j++) {
                    let val;
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        val = row[j - 1]; // Match
                    } else {
                        val = Math.min(
                            row[j - 1] + 1, // Substitution
                            prev + 1,       // Insertion
                            row[j] + 1      // Deletion
                        );
                    }
                    row[j - 1] = prev;
                    prev = val;
                }
                row[a.length] = prev;
            }

            return row[a.length];
        }
    </script>
    <script src="compare.js"></script>
</body>
</html>
